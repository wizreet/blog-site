---
/**
 * Hidden Music Page
 *
 * @description A hidden page showing personal music videos.
 * Not linked in navigation, not in sitemap, not in RSS.
 * Only accessible via direct link or from the About page.
 *
 * @route /music
 */

import { Icon } from 'astro-icon/components';
import Layout from '@layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '@utils/date-utils';
import { i18n, I18nKey } from '@i18n/index';

// Get all music videos
let musicVideos: any[] = [];
try {
  musicVideos = await getCollection('music');
  // Sort by date (newest first)
  musicVideos.sort((a, b) => b.data.published.getTime() - a.data.published.getTime());
} catch (e) {
  // No music collection
}
---

<Layout title={i18n(I18nKey.music)} robots="noindex, nofollow">
  <div class="min-h-screen bg-[var(--page-bg)]">
    <!-- Header -->
    <header class="border-b border-[var(--border-color)] bg-[var(--card-bg)]/80 backdrop-blur-lg">
      <div class="container-page flex h-16 items-center justify-between">
        <a href="/" class="text-xl font-bold transition-colors hover:text-[oklch(var(--primary))]">
          ‚Üê Back
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container-page py-12">
      <div class="mx-auto max-w-4xl">
        <!-- Page Header -->
        <header class="mb-12 text-center">
          <h1 class="flex items-center justify-center gap-3 text-4xl font-bold text-[var(--text-primary)]">
            <Icon name="material-symbols:music-note" class="h-10 w-10" />
            My Music
          </h1>
          <p class="mt-4 text-lg text-[var(--text-secondary)]">
            Personal music videos and covers. Thanks for finding this hidden page! üé∏
          </p>
        </header>

        <!-- Videos Grid -->
        {
          musicVideos.length > 0 ? (
            <div class="grid gap-6 md:grid-cols-2">
              {musicVideos.map((video) => {
                const { title, artist, youtubeId, published, notes } = video.data;
                const thumbnailUrl = youtubeId
                  ? `https://img.youtube.com/vi/${youtubeId}/mqdefault.jpg`
                  : null;

                return (
                  <div class="card-base group cursor-pointer overflow-hidden" data-video-id={youtubeId}>
                    {/* Thumbnail */}
                    {thumbnailUrl && (
                      <div class="relative aspect-video overflow-hidden">
                        <img
                          src={thumbnailUrl}
                          alt={title}
                          class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                          loading="lazy"
                        />
                        {/* Play Overlay */}
                        <div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
                          <div class="flex h-14 w-14 items-center justify-center rounded-full bg-white/90 text-red-600">
                            <Icon name="material-symbols:play-arrow" class="h-8 w-8" />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Content */}
                    <div class="p-4">
                      <h3 class="font-bold text-[var(--text-primary)] transition-colors group-hover:text-[oklch(var(--primary))]">
                        {title}
                      </h3>
                      {artist && (
                        <p class="mt-1 text-sm text-[var(--text-secondary)]">
                          {artist}
                        </p>
                      )}
                      {notes && (
                        <p class="mt-2 line-clamp-2 text-xs text-[var(--text-tertiary)]">
                          {notes}
                        </p>
                      )}
                      <div class="mt-3 flex items-center gap-2 text-xs text-[var(--text-tertiary)]">
                        <Icon name="material-symbols:calendar-today-outline" class="h-3.5 w-3.5" />
                        <time datetime={published.toISOString()}>
                          {formatDate(published)}
                        </time>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div class="rounded-xl bg-[var(--card-bg)] p-8 text-center">
              <Icon
                name="material-symbols:music-off-outline"
                class="mx-auto mb-4 h-12 w-12 text-[var(--text-tertiary)]"
              />
              <p class="text-[var(--text-secondary)]">
                No videos yet. Check back later!
              </p>
            </div>
          )
        }
      </div>
    </main>

    <!-- Video Modal -->
    <div
      id="video-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4"
    >
      <div class="relative w-full max-w-4xl">
        <button
          id="close-modal"
          class="absolute -top-10 right-0 text-white hover:text-gray-300"
        >
          <Icon name="material-symbols:close" class="h-8 w-8" />
        </button>
        <div id="video-container" class="aspect-video w-full">
          <!-- YouTube iframe will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    function initVideoModal() {
      const modal = document.getElementById('video-modal');
      const container = document.getElementById('video-container');
      const closeBtn = document.getElementById('close-modal');

      if (!modal || !container || !closeBtn) return;

      // Open modal on card click
      document.querySelectorAll('[data-video-id]').forEach((card) => {
        card.addEventListener('click', () => {
          const videoId = card.getAttribute('data-video-id');
          if (!videoId) return;

          // Create iframe
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1`;
          iframe.allow =
            'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.allowFullscreen = true;
          iframe.className = 'h-full w-full';

          container.innerHTML = '';
          container.appendChild(iframe);
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          document.body.style.overflow = 'hidden';
        });
      });

      // Close modal
      function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        container.innerHTML = '';
        document.body.style.overflow = '';
      }

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
    }

    initVideoModal();
    document.addEventListener('astro:after-swap', initVideoModal);
  </script>
</Layout>
