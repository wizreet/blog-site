---
/**
 * Category Posts Page
 *
 * @description Lists all posts in a specific category.
 * Dynamic route: /posts/category/[category]/
 *
 * @route /posts/category/[category]/
 */

import DashboardLayout from '@layouts/DashboardLayout.astro';
import PostCard from '@components/card/PostCard.astro';
import { getCategoryList, getPostsByCategory } from '@utils/content-utils';
import { i18n, I18nKey } from '@i18n/index';
import { Icon } from 'astro-icon/components';
import { getUrl } from '@utils/url-utils';

export async function getStaticPaths() {
  const categories = await getCategoryList();

  return categories.map((category) => ({
    params: { category: category.name.toLowerCase() },
    props: { categoryName: category.name },
  }));
}

interface Props {
  categoryName: string;
}

const { category } = Astro.params;
const { categoryName } = Astro.props;

// Get posts for this category
const posts = await getPostsByCategory(categoryName);

// Group posts by year
const postsByYear = posts.reduce(
  (acc, post) => {
    const year = new Date(post.data.published).getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof posts>
);

// Sort years descending
const sortedYears = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<DashboardLayout
  title={`${categoryName} - ${i18n(I18nKey.categories)}`}
  description={`All posts in the ${categoryName} category`}
  activeCategory={categoryName}
>
  <div class="category-page">
    {/* Page Header */}
    <header class="page-header">
      <a href={getUrl('/posts/')} class="back-link">
        <Icon name="material-symbols:arrow-back" class="back-icon" />
        <span>{i18n(I18nKey.allPosts)}</span>
      </a>

      <div class="header-content">
        <div class="category-badge">
          <Icon name="material-symbols:label" class="badge-icon" />
          <span>{i18n(I18nKey.categories)}</span>
        </div>
        <h1 class="page-title">{categoryName}</h1>
        <p class="page-subtitle">
          {posts.length}
          {posts.length === 1 ? i18n(I18nKey.postCount) : i18n(I18nKey.postsCount)}
        </p>
      </div>
    </header>

    {/* Posts grouped by year */}
    <div class="posts-timeline">
      {sortedYears.map((year) => (
        <section class="year-section">
          <h2 class="year-header">
            <span class="year-text">{year}</span>
            <span class="year-count">
              {postsByYear[year].length}
            </span>
          </h2>

          <div class="posts-list">
            {postsByYear[year].map((post) => (
              <PostCard post={post} />
            ))}
          </div>
        </section>
      ))}
    </div>

    {/* Empty State */}
    {posts.length === 0 && (
      <div class="empty-state">
        <p>No posts in this category yet.</p>
      </div>
    )}
  </div>
</DashboardLayout>

<style>
  .category-page {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Page Header */
  .page-header {
    padding: 1.5rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: 1rem;
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: oklch(var(--primary));
  }

  .back-icon {
    width: 1rem;
    height: 1rem;
  }

  .header-content {
    /* No extra spacing needed */
  }

  .category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: oklch(var(--primary));
    margin-bottom: 0.5rem;
  }

  .badge-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .page-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.375rem;
  }

  .page-subtitle {
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }

  /* Timeline */
  .posts-timeline {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .year-section {
    position: relative;
  }

  .year-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    background: oklch(var(--primary) / 0.05);
    border-radius: 8px;
    border-left: 3px solid oklch(var(--primary));
  }

  .year-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .year-count {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    font-weight: 500;
    background: var(--btn-regular-bg);
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-secondary);
  }

  /* Responsive */
  @media (min-width: 768px) {
    .page-header {
      padding: 2rem;
    }

    .page-title {
      font-size: 2rem;
    }
  }
</style>
