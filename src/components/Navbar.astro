---
/**
 * Navbar Component
 *
 * @description The main navigation bar that appears at the top of all pages.
 * Features:
 * - Site branding (title or logo)
 * - Navigation links (supports presets and custom links)
 * - Theme toggle
 * - Search button
 * - Mobile menu toggle
 *
 * Based on Mizuki's Navbar patterns.
 */

import { Icon } from 'astro-icon/components';
import { siteConfig, getNavLinks } from '@/config';
import { getUrl } from '@utils/url-utils';
import ThemeSwitch from '@components/ThemeSwitch.tsx';
import Search from '@components/Search.tsx';
import type { NavLink } from '@/types/config';

// Get resolved navigation links (converts presets to actual links)
const links: NavLink[] = getNavLinks();

// Get current path for active link highlighting
const currentPath = Astro.url.pathname;

/**
 * Check if a nav link is active
 * Handles base URL prefix and trailing slashes
 */
function isActiveLink(href: string): boolean {
  // Normalize paths by removing trailing slashes
  const normalizedPath = currentPath.replace(/\/+$/, '') || '/';
  const normalizedHref = href.replace(/\/+$/, '') || '/';

  // Home is only active when exactly on home page
  if (normalizedHref === '/' || normalizedHref === getUrl('/').replace(/\/+$/, '')) {
    return normalizedPath === '/' || normalizedPath === getUrl('/').replace(/\/+$/, '');
  }

  // For other links, check if current path starts with the link path
  // But only if it's a proper path segment (not partial match)
  return normalizedPath === normalizedHref ||
    normalizedPath.startsWith(normalizedHref + '/');
}

/**
 * Check if link has children (is a dropdown)
 */
function hasChildren(link: NavLink): boolean {
  return !!(link.children && link.children.length > 0);
}
---

<header
  id="navbar"
  class="fixed left-0 right-0 top-0 z-40 h-[var(--navbar-height)] border-b border-[var(--border-color)] bg-[var(--card-bg)]/80 backdrop-blur-lg transition-all duration-300"
>
  <nav class="container-page flex h-full items-center justify-between gap-4">
    <!-- Left: Sidebar Toggle + Site Title -->
    <div class="flex items-center gap-2">
      <!-- Sidebar Toggle (Desktop) -->
      <button
        id="sidebar-toggle"
        class="btn-plain hidden lg:flex items-center justify-center h-10 w-10 rounded-lg flex-shrink-0"
        aria-label="Toggle sidebar"
        aria-expanded="true"
        title="Toggle sidebar"
      >
        <Icon name="material-symbols:menu-open" class="sidebar-icon-open h-5 w-5" />
        <Icon name="material-symbols:menu" class="sidebar-icon-closed h-5 w-5 hidden" />
      </button>

      <!-- Site Title/Logo -->
      <a
        href={getUrl('/')}
        class="flex items-center gap-2 text-lg font-semibold text-[var(--text-primary)] hover:text-[oklch(var(--primary))] transition-colors"
      >
        <span class="truncate max-w-[180px] md:max-w-none">{siteConfig.title}</span>
      </a>
    </div>

    <!-- Desktop Navigation -->
    <div class="hidden items-center gap-1 md:flex">
      {
        links.map((link) =>
          hasChildren(link) ? (
            /* Dropdown Menu */
            <div class="dropdown-container relative">
              <button
                class="btn-plain flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium"
                aria-haspopup="true"
                aria-expanded="false"
              >
                {link.icon && <Icon name={link.icon} class="h-4 w-4" />}
                <span>{link.name}</span>
                <Icon name="material-symbols:expand-more" class="h-4 w-4 transition-transform" />
              </button>
              <div class="dropdown-menu absolute right-0 top-full z-50 mt-1 hidden min-w-[160px] rounded-lg bg-[var(--card-bg)] p-2 shadow-lg border border-[var(--border-color)]">
                {link.children?.map((child) => (
                  <a
                    href={child.external ? child.url : getUrl(child.url)}
                    target={child.external ? '_blank' : undefined}
                    rel={child.external ? 'noopener noreferrer' : undefined}
                    class="flex items-center gap-2 rounded-md px-3 py-2 text-sm text-[var(--text-secondary)] transition-colors hover:bg-[var(--btn-hover-bg)] hover:text-[var(--text-primary)]"
                  >
                    {child.icon && <Icon name={child.icon} class="h-4 w-4" />}
                    <span>{child.name}</span>
                    {child.external && <Icon name="material-symbols:open-in-new" class="h-3 w-3 opacity-50" />}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            /* Regular Link */
            <a
              href={link.external ? link.url : getUrl(link.url)}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
              class:list={[
                'btn-plain flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-all',
                isActiveLink(getUrl(link.url))
                  ? 'bg-[var(--btn-hover-bg)] text-[oklch(var(--primary))]'
                  : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)]',
              ]}
            >
              {link.icon && <Icon name={link.icon} class="h-4 w-4" />}
              <span>{link.name}</span>
              {link.external && <Icon name="material-symbols:open-in-new" class="h-3 w-3 opacity-50" />}
            </a>
          )
        )
      }
    </div>

    <!-- Right Side Actions -->
    <div class="flex items-center gap-1">
      <!-- Search Button -->
      <Search client:load />

      <!-- Theme Toggle -->
      <ThemeSwitch client:load />

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-menu-toggle"
        class="btn-plain md:hidden"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <Icon name="material-symbols:menu" class="h-5 w-5" />
      </button>
    </div>
  </nav>
</header>

<!-- Mobile Menu -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-30 hidden pt-[var(--navbar-height)]"
  aria-hidden="true"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="mobile-menu-backdrop"></div>

  <!-- Menu Panel -->
  <div
    class="absolute right-0 top-[var(--navbar-height)] h-[calc(100vh-var(--navbar-height))] w-72 translate-x-full transform overflow-y-auto bg-[var(--card-bg)] shadow-xl transition-transform duration-300 ease-out"
    id="mobile-menu-panel"
  >
    <nav class="flex flex-col gap-1 p-4">
      {
        links.map((link) =>
          hasChildren(link) ? (
            /* Mobile Dropdown */
            <div class="mobile-dropdown">
              <button
                class="flex w-full items-center justify-between rounded-lg px-4 py-3 text-sm font-medium text-[var(--text-secondary)] transition-colors hover:bg-[var(--btn-hover-bg)]"
                aria-expanded="false"
              >
                <span class="flex items-center gap-2">
                  {link.icon && <Icon name={link.icon} class="h-5 w-5" />}
                  {link.name}
                </span>
                <Icon name="material-symbols:expand-more" class="h-5 w-5 transition-transform" />
              </button>
              <div class="mobile-dropdown-content hidden pl-4">
                {link.children?.map((child) => (
                  <a
                    href={child.external ? child.url : getUrl(child.url)}
                    target={child.external ? '_blank' : undefined}
                    rel={child.external ? 'noopener noreferrer' : undefined}
                    class="flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm text-[var(--text-tertiary)] transition-colors hover:bg-[var(--btn-hover-bg)] hover:text-[var(--text-primary)]"
                  >
                    {child.icon && <Icon name={child.icon} class="h-4 w-4" />}
                    <span>{child.name}</span>
                    {child.external && <Icon name="material-symbols:open-in-new" class="h-3 w-3 opacity-50" />}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            /* Mobile Regular Link */
            <a
              href={link.external ? link.url : getUrl(link.url)}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
              class:list={[
                'flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium transition-colors',
                isActiveLink(getUrl(link.url))
                  ? 'bg-[var(--btn-hover-bg)] text-[oklch(var(--primary))]'
                  : 'text-[var(--text-secondary)] hover:bg-[var(--btn-hover-bg)] hover:text-[var(--text-primary)]',
              ]}
            >
              {link.icon && <Icon name={link.icon} class="h-5 w-5" />}
              <span>{link.name}</span>
              {link.external && <Icon name="material-symbols:open-in-new" class="h-4 w-4 opacity-50" />}
            </a>
          )
        )
      }
    </nav>
  </div>
</div>

<style>
  /* Dropdown hover styles */
  .dropdown-container:hover .dropdown-menu,
  .dropdown-container:focus-within .dropdown-menu {
    display: block;
    animation: dropdown-fade 0.15s ease-out;
  }

  .dropdown-container:hover button svg:last-child {
    transform: rotate(180deg);
  }

  @keyframes dropdown-fade {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Scale animation utility */
  .scale-animation {
    transition: transform 0.15s ease;
  }
  .scale-animation:active {
    transform: scale(0.95);
  }
</style>

<script>
  function initNavbar() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const panel = document.getElementById('mobile-menu-panel');
    const backdrop = document.getElementById('mobile-menu-backdrop');

    if (!toggle || !menu || !panel || !backdrop) return;

    // Store references to avoid null checks in closures
    const menuEl = menu;
    const panelEl = panel;
    const toggleEl = toggle;

    let isOpen = false;

    function openMenu() {
      isOpen = true;
      menuEl.classList.remove('hidden');
      menuEl.setAttribute('aria-hidden', 'false');
      toggleEl.setAttribute('aria-expanded', 'true');
      // Use requestAnimationFrame for smoother animation
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          panelEl.classList.remove('translate-x-full');
        });
      });
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      if (!isOpen) return;
      isOpen = false;
      panelEl.classList.add('translate-x-full');
      toggleEl.setAttribute('aria-expanded', 'false');
      setTimeout(() => {
        if (!isOpen) {
          menuEl.classList.add('hidden');
          menuEl.setAttribute('aria-hidden', 'true');
        }
      }, 300);
      document.body.style.overflow = '';
    }

    // Remove old listeners by cloning elements
    const newToggle = toggleEl.cloneNode(true) as HTMLElement;
    toggleEl.parentNode?.replaceChild(newToggle, toggleEl);

    const newBackdrop = backdrop.cloneNode(true) as HTMLElement;
    backdrop.parentNode?.replaceChild(newBackdrop, backdrop);

    // Add fresh listeners
    newToggle.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      isOpen ? closeMenu() : openMenu();
    });

    newBackdrop.addEventListener('click', (e) => {
      e.preventDefault();
      closeMenu();
    });

    // Escape key handler
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
      }
    };
    document.removeEventListener('keydown', handleEscape);
    document.addEventListener('keydown', handleEscape);

    // Mobile dropdowns
    document.querySelectorAll('.mobile-dropdown button').forEach((btn) => {
      const newBtn = btn.cloneNode(true) as HTMLElement;
      btn.parentNode?.replaceChild(newBtn, btn);

      newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const content = newBtn.nextElementSibling;
        const icon = newBtn.querySelector('svg:last-child') as HTMLElement;
        const isExpanded = newBtn.getAttribute('aria-expanded') === 'true';
        newBtn.setAttribute('aria-expanded', (!isExpanded).toString());
        content?.classList.toggle('hidden');
        if (icon) icon.style.transform = isExpanded ? '' : 'rotate(180deg)';
      });
    });

    // Close on link click
    menuEl.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });
  }

  // Sidebar toggle functionality
  function initSidebarToggle() {
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const dashboardContainer = document.querySelector('.dashboard-container');

    if (!sidebarToggle || !dashboardContainer) return;

    // Check localStorage for saved preference
    const savedState = localStorage.getItem('sidebar-collapsed');
    let isCollapsed = savedState === 'true';

    function updateSidebarState() {
      const openIcon = sidebarToggle?.querySelector('.sidebar-icon-open');
      const closedIcon = sidebarToggle?.querySelector('.sidebar-icon-closed');

      if (isCollapsed) {
        dashboardContainer?.classList.add('sidebar-collapsed');
        sidebarToggle?.setAttribute('aria-expanded', 'false');
        openIcon?.classList.add('hidden');
        closedIcon?.classList.remove('hidden');
      } else {
        dashboardContainer?.classList.remove('sidebar-collapsed');
        sidebarToggle?.setAttribute('aria-expanded', 'true');
        openIcon?.classList.remove('hidden');
        closedIcon?.classList.add('hidden');
      }
    }

    // Initialize state
    updateSidebarState();

    // Remove old listener by cloning
    const newSidebarToggle = sidebarToggle.cloneNode(true) as HTMLElement;
    sidebarToggle.parentNode?.replaceChild(newSidebarToggle, sidebarToggle);

    newSidebarToggle.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      isCollapsed = !isCollapsed;
      localStorage.setItem('sidebar-collapsed', isCollapsed.toString());

      // Re-query elements after clone
      const container = document.querySelector('.dashboard-container');
      const openIcon = newSidebarToggle.querySelector('.sidebar-icon-open');
      const closedIcon = newSidebarToggle.querySelector('.sidebar-icon-closed');

      if (isCollapsed) {
        container?.classList.add('sidebar-collapsed');
        newSidebarToggle.setAttribute('aria-expanded', 'false');
        openIcon?.classList.add('hidden');
        closedIcon?.classList.remove('hidden');
      } else {
        container?.classList.remove('sidebar-collapsed');
        newSidebarToggle.setAttribute('aria-expanded', 'true');
        openIcon?.classList.remove('hidden');
        closedIcon?.classList.add('hidden');
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initNavbar();
    initSidebarToggle();
  });

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    initNavbar();
    initSidebarToggle();
  });

  // Fallback: also init immediately in case DOMContentLoaded already fired
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initNavbar();
    initSidebarToggle();
  }
</script>
