---
/**
 * Navbar Component
 *
 * @description The main navigation bar that appears at the top of all pages.
 * Features:
 * - Site branding (title or logo)
 * - Navigation links
 * - Theme toggle
 * - Search button
 * - Mobile menu toggle
 *
 * The navbar is fixed at the top and has a blur backdrop.
 */

import { Icon } from 'astro-icon/components';
import { siteConfig, navBarConfig } from '@/config';
import { i18n, I18nKey } from '@i18n/index';
import { getUrl } from '@utils/url-utils';
import { NAV_ICONS } from '@constants/icon';
import ThemeSwitch from '@components/ThemeSwitch.tsx';
import Search from '@components/Search.tsx';

// Get current path for active link highlighting
const currentPath = Astro.url.pathname;

/**
 * Check if a nav link is active
 */
function isActiveLink(href: string): boolean {
  // Remove trailing slash for comparison
  const normalizedPath = currentPath.replace(/\/$/, '') || '/';
  const normalizedHref = href.replace(/\/$/, '') || '/';

  // Exact match for home
  if (normalizedHref === '/' || normalizedHref === getUrl('/')) {
    return normalizedPath === '/' || normalizedPath === getUrl('/').replace(/\/$/, '');
  }

  // Prefix match for other pages
  return normalizedPath.startsWith(normalizedHref);
}
---

<header
  class="fixed left-0 right-0 top-0 z-40 h-[var(--navbar-height)] border-b border-[var(--border-color)] bg-[var(--card-bg)]/80 backdrop-blur-lg"
>
  <nav class="container-page flex h-full items-center justify-between">
    <!-- Logo / Site Title -->
    <a
      href={getUrl('/')}
      class="flex items-center gap-2 text-xl font-bold transition-colors hover:text-[oklch(var(--primary))]"
    >
      {
        siteConfig.logo ? (
          <img
            src={siteConfig.logo}
            alt={siteConfig.title}
            class="h-8 w-8 rounded-full object-cover"
          />
        ) : null
      }
      <span class="hidden sm:inline">{siteConfig.title}</span>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden items-center gap-1 md:flex">
      {
        navBarConfig.links.map((link) => (
          <a
            href={link.external ? link.url : getUrl(link.url)}
            target={link.external ? '_blank' : undefined}
            rel={link.external ? 'noopener noreferrer' : undefined}
            class:list={[
              'flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
              isActiveLink(getUrl(link.url))
                ? 'bg-[var(--btn-hover-bg)] text-[oklch(var(--primary))]'
                : 'text-[var(--text-secondary)] hover:bg-[var(--btn-hover-bg)] hover:text-[var(--text-primary)]',
            ]}
          >
            {link.icon && (
              <Icon name={link.icon} class="h-4 w-4" />
            )}
            <span>{link.name}</span>
            {link.external && (
              <Icon name="material-symbols:open-in-new" class="h-3 w-3 opacity-50" />
            )}
          </a>
        ))
      }
    </div>

    <!-- Right Side Actions -->
    <div class="flex items-center gap-1">
      <!-- Search Button -->
      <Search client:load />

      <!-- Theme Toggle -->
      <ThemeSwitch client:load />

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-menu-toggle"
        class="btn-plain md:hidden"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <Icon name="material-symbols:menu" class="h-5 w-5" />
      </button>
    </div>
  </nav>
</header>

<!-- Mobile Menu -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-30 hidden pt-[var(--navbar-height)]"
  aria-hidden="true"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50" id="mobile-menu-backdrop"></div>

  <!-- Menu Panel -->
  <div
    class="absolute right-0 top-[var(--navbar-height)] h-[calc(100vh-var(--navbar-height))] w-64 translate-x-full transform overflow-y-auto bg-[var(--card-bg)] shadow-lg transition-transform duration-300"
    id="mobile-menu-panel"
  >
    <nav class="flex flex-col p-4">
      {
        navBarConfig.links.map((link) => (
          <a
            href={link.external ? link.url : getUrl(link.url)}
            target={link.external ? '_blank' : undefined}
            rel={link.external ? 'noopener noreferrer' : undefined}
            class:list={[
              'flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium transition-colors',
              isActiveLink(getUrl(link.url))
                ? 'bg-[var(--btn-hover-bg)] text-[oklch(var(--primary))]'
                : 'text-[var(--text-secondary)] hover:bg-[var(--btn-hover-bg)] hover:text-[var(--text-primary)]',
            ]}
          >
            {link.icon && (
              <Icon name={link.icon} class="h-5 w-5" />
            )}
            <span>{link.name}</span>
            {link.external && (
              <Icon name="material-symbols:open-in-new" class="h-4 w-4 opacity-50" />
            )}
          </a>
        ))
      }
    </nav>
  </div>
</div>

<script>
  // Mobile menu toggle functionality
  function initMobileMenu() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const panel = document.getElementById('mobile-menu-panel');
    const backdrop = document.getElementById('mobile-menu-backdrop');

    if (!toggle || !menu || !panel || !backdrop) return;

    let isOpen = false;

    function openMenu() {
      isOpen = true;
      menu.classList.remove('hidden');
      menu.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');

      // Animate panel in
      requestAnimationFrame(() => {
        panel.classList.remove('translate-x-full');
      });

      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      isOpen = false;
      panel.classList.add('translate-x-full');
      toggle.setAttribute('aria-expanded', 'false');

      // Hide menu after animation
      setTimeout(() => {
        menu.classList.add('hidden');
        menu.setAttribute('aria-hidden', 'true');
      }, 300);

      // Restore body scroll
      document.body.style.overflow = '';
    }

    toggle.addEventListener('click', () => {
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    backdrop.addEventListener('click', closeMenu);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
      }
    });

    // Close on route change (for view transitions)
    document.addEventListener('astro:before-swap', closeMenu);
  }

  // Initialize on load
  initMobileMenu();

  // Re-initialize after view transitions
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
