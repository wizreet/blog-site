---
/**
 * Right Sidebar Component
 *
 * Clean, professional implementation with:
 * - Always-visible toggle button
 * - Accordion behavior for series/categories
 * - Expandable posts list
 * - Proper state management
 */

import { Icon } from 'astro-icon/components';
import { getCategoryList, getSeriesWithCounts, getSortedPosts } from '@utils/content-utils';
import { getUrl, getPostUrl } from '@utils/url-utils';
import { i18n, I18nKey } from '@i18n/index';
import type { MarkdownHeading } from 'astro';

interface Props {
  headings?: MarkdownHeading[];
}

const { headings = [] } = Astro.props;

// Fetch data
const categories = await getCategoryList();
const seriesWithCounts = await getSeriesWithCounts();
const allPosts = await getSortedPosts();

const seriesWithPosts = seriesWithCounts.filter((s) => s.postCount > 0);
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

// Group posts
const postsBySeries = new Map<string, typeof allPosts>();
const postsByCategory = new Map<string, typeof allPosts>();

allPosts.forEach((post) => {
  if (post.data.series?.id) {
    const id = post.data.series.id;
    if (!postsBySeries.has(id)) postsBySeries.set(id, []);
    postsBySeries.get(id)!.push(post);
  }

  const cat = post.data.category?.toLowerCase() || 'uncategorized';
  if (!postsByCategory.has(cat)) postsByCategory.set(cat, []);
  postsByCategory.get(cat)!.push(post);
});
---

<div class="right-sidebar-wrapper" id="right-sidebar-wrapper">
  {/* Toggle Button - Fancy animated arrow with glow */}
  <button
    class="toggle-btn"
    id="right-sidebar-toggle"
    type="button"
    aria-label="Toggle right sidebar"
    title="Toggle sidebar"
  >
    <span class="toggle-arrow">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </span>
    <span class="toggle-glow"></span>
  </button>

  {/* Sidebar Content */}
  <div class="sidebar-content" id="right-sidebar-content">
    {/* TOC */}
    {tocHeadings.length > 0 && (
      <section class="sidebar-section">
        <header class="section-header">
          <Icon name="material-symbols:list" class="header-icon" />
          <span class="header-title">{i18n(I18nKey.tableOfContents)}</span>
        </header>
        <nav class="toc-nav">
          <ul class="toc-list">
            {tocHeadings.map((h) => (
              <li class:list={['toc-item', `depth-${h.depth}`]}>
                <a href={`#${h.slug}`} class="toc-link" data-toc-link>{h.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      </section>
    )}

    {/* Series */}
    {seriesWithPosts.length > 0 && (
      <section class="sidebar-section">
        <header class="section-header">
          <Icon name="material-symbols:library-books" class="header-icon" />
          <span class="header-title">{i18n(I18nKey.series)}</span>
          <span class="header-count">{seriesWithPosts.length}</span>
        </header>
        <div class="section-content">
          {seriesWithPosts.map((series) => {
            const posts = postsBySeries.get(series.id) || [];
            return (
              <div class="accordion-item" data-accordion>
                <button class="accordion-header" type="button" aria-expanded="false">
                  <Icon name="material-symbols:book-2-outline" class="item-icon" />
                  <span class="item-name">{series.title}</span>
                  <span class:list={['item-badge', series.status]}>{series.postCount}</span>
                  <Icon name="material-symbols:chevron-right" class="chevron" />
                </button>
                <div class="accordion-panel">
                  {posts.map((post, i) => (
                    <a href={getPostUrl(post.id)} class="panel-link">
                      <span class="link-num">{i + 1}</span>
                      <span class="link-text">{post.data.title}</span>
                    </a>
                  ))}
                  <a href={getUrl(`/series/${series.id}/`)} class="panel-view-all">
                    View all →
                  </a>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    {/* Categories */}
    <section class="sidebar-section">
      <header class="section-header">
        <Icon name="material-symbols:folder-open" class="header-icon" />
        <span class="header-title">{i18n(I18nKey.categories)}</span>
        <span class="header-count">{categories.length}</span>
      </header>
      <div class="section-content">
        {categories.map((cat) => {
          const posts = postsByCategory.get(cat.name.toLowerCase()) || [];
          return (
            <div class="accordion-item" data-accordion>
              <button class="accordion-header" type="button" aria-expanded="false">
                <Icon name="material-symbols:label-outline" class="item-icon" />
                <span class="item-name">{cat.name}</span>
                <span class="item-badge">{cat.count}</span>
                <Icon name="material-symbols:chevron-right" class="chevron" />
              </button>
              <div class="accordion-panel">
                {posts.slice(0, 5).map((post) => (
                  <a href={getPostUrl(post.id)} class="panel-link">
                    <span class="link-text">{post.data.title}</span>
                  </a>
                ))}
                <a href={getUrl(`/posts/category/${cat.name.toLowerCase()}/`)} class="panel-view-all">
                  {posts.length > 5 ? `View all ${posts.length} →` : 'View category →'}
                </a>
              </div>
            </div>
          );
        })}
      </div>
    </section>
  </div>
</div>

<style>
  .right-sidebar-wrapper {
    position: relative;
  }

  /* Toggle Button - Fancy Arrow with Glow */
  .toggle-btn {
    position: fixed;
    top: calc(var(--navbar-height) + 1rem);
    right: 1rem;
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, oklch(var(--primary) / 0.15), oklch(var(--primary) / 0.25));
    color: oklch(var(--primary));
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toggle-btn:hover {
    transform: scale(1.1);
    background: linear-gradient(135deg, oklch(var(--primary) / 0.25), oklch(var(--primary) / 0.35));
  }

  .toggle-btn:active {
    transform: scale(0.95);
  }

  /* Arrow icon */
  .toggle-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 2;
  }

  .toggle-arrow svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 0 3px oklch(var(--primary) / 0.5));
  }

  /* When sidebar visible, arrow points right (to close/collapse) */
  .toggle-btn.sidebar-visible .toggle-arrow {
    transform: rotate(0deg);
  }

  /* When sidebar hidden, arrow points left (to open/expand) */
  .toggle-btn:not(.sidebar-visible) .toggle-arrow {
    transform: rotate(180deg);
  }

  /* Glow effect */
  .toggle-glow {
    position: absolute;
    inset: -2px;
    border-radius: 50%;
    background: conic-gradient(
      from 0deg,
      oklch(var(--primary) / 0),
      oklch(var(--primary) / 0.6),
      oklch(var(--primary) / 0)
    );
    opacity: 0;
    animation: none;
    transition: opacity 0.3s ease;
    z-index: 1;
  }

  .toggle-btn:hover .toggle-glow {
    opacity: 1;
    animation: spin-glow 2s linear infinite;
  }

  @keyframes spin-glow {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* Inner background to mask the glow */
  .toggle-btn::before {
    content: '';
    position: absolute;
    inset: 2px;
    border-radius: 50%;
    background: var(--card-bg);
    z-index: 1;
  }

  .toggle-btn:hover::before {
    background: linear-gradient(135deg, oklch(var(--primary) / 0.08), oklch(var(--primary) / 0.15));
  }

  /* Sidebar Content */
  .sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Section */
  .sidebar-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: oklch(var(--primary) / 0.05);
    border-bottom: 1px solid var(--border-color);
  }

  .header-icon {
    width: 1rem;
    height: 1rem;
    color: oklch(var(--primary));
    flex-shrink: 0;
  }

  .header-title {
    flex: 1;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-primary);
  }

  .header-count {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: 10px;
    background: oklch(var(--primary) / 0.12);
    color: oklch(var(--primary));
  }

  .section-content {
    padding: 0.5rem;
  }

  /* Accordion */
  .accordion-item {
    margin-bottom: 0.25rem;
  }

  .accordion-item:last-child {
    margin-bottom: 0;
  }

  .accordion-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.625rem;
    border: none;
    border-radius: 6px;
    background: transparent;
    font-family: inherit;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-align: left;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .accordion-header:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .accordion-header[aria-expanded='true'] {
    background: oklch(var(--primary) / 0.08);
    color: oklch(var(--primary));
  }

  .item-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .accordion-header:hover .item-icon,
  .accordion-header[aria-expanded='true'] .item-icon {
    opacity: 1;
    color: oklch(var(--primary));
  }

  .item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 8px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
    flex-shrink: 0;
  }

  .item-badge.ongoing {
    background: oklch(0.65 0.15 145 / 0.15);
    color: oklch(0.5 0.15 145);
  }

  .item-badge.completed {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  .accordion-header[aria-expanded='true'] .item-badge {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  .chevron {
    width: 0.875rem;
    height: 0.875rem;
    flex-shrink: 0;
    color: var(--text-tertiary);
    transition: transform 0.2s ease;
  }

  .accordion-header[aria-expanded='true'] .chevron {
    transform: rotate(90deg);
    color: oklch(var(--primary));
  }

  /* Panel */
  .accordion-panel {
    display: none;
    padding: 0.25rem 0 0.25rem 1.5rem;
    margin-left: 0.5rem;
    border-left: 2px solid var(--border-color);
  }

  .accordion-panel.open {
    display: block;
  }

  .panel-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.5rem;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.75rem;
    color: var(--text-secondary);
    transition: all 0.15s ease;
  }

  .panel-link:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .link-num {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.125rem;
    height: 1.125rem;
    font-size: 0.625rem;
    font-weight: 600;
    border-radius: 4px;
    background: var(--border-color);
    color: var(--text-tertiary);
    flex-shrink: 0;
  }

  .link-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .panel-view-all {
    display: block;
    padding: 0.375rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 500;
    color: oklch(var(--primary));
    text-decoration: none;
    transition: opacity 0.15s ease;
  }

  .panel-view-all:hover {
    opacity: 0.8;
  }

  /* TOC */
  .toc-nav {
    padding: 0.5rem;
    max-height: 40vh;
    overflow-y: auto;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.625rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.15s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .toc-link:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .toc-link.active {
    background: oklch(var(--primary) / 0.1);
    color: oklch(var(--primary));
    font-weight: 500;
  }

  .toc-item.depth-3 .toc-link {
    padding-left: 1.25rem;
    font-size: 0.75rem;
  }

  /* Responsive */
  @media (min-width: 768px) {
    .toggle-btn {
      display: flex;
    }

    /* Position relative to sidebar */
    .toggle-btn {
      right: calc(260px + 1.5rem);
    }

    /* When collapsed */
    :global([data-right-collapsed='true']) .toggle-btn {
      right: 1rem;
    }

    :global([data-right-collapsed='true']) .sidebar-content {
      display: none;
    }
  }

  @media (min-width: 1280px) {
    .toggle-btn {
      right: calc(280px + 1.5rem);
    }
  }
</style>

<script>
  function initRightSidebar() {
    const wrapper = document.getElementById('right-sidebar-wrapper');
    const toggleBtn = document.getElementById('right-sidebar-toggle');

    if (!wrapper || !toggleBtn) return;

    // Prevent double initialization
    if (wrapper.hasAttribute('data-init')) return;
    wrapper.setAttribute('data-init', 'true');

    // Update toggle button state
    const updateToggleState = () => {
      const container = document.querySelector('.dashboard-container');
      const isCollapsed = container?.hasAttribute('data-right-collapsed');
      toggleBtn.classList.toggle('sidebar-visible', !isCollapsed);
    };

    // Initial state
    updateToggleState();

    // Toggle click handler
    toggleBtn.addEventListener('click', () => {
      const SidebarManager = (window as any).SidebarManager;
      if (SidebarManager) {
        SidebarManager.toggleRight();
        updateToggleState();
      }
    });

    // Accordion functionality
    const accordionItems = wrapper.querySelectorAll('[data-accordion]');

    accordionItems.forEach((item) => {
      const header = item.querySelector('.accordion-header');
      const panel = item.querySelector('.accordion-panel');

      if (!header || !panel) return;

      header.addEventListener('click', () => {
        const isOpen = header.getAttribute('aria-expanded') === 'true';

        // Close all other panels
        accordionItems.forEach((other) => {
          if (other !== item) {
            other.querySelector('.accordion-header')?.setAttribute('aria-expanded', 'false');
            other.querySelector('.accordion-panel')?.classList.remove('open');
          }
        });

        // Toggle current
        header.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        panel.classList.toggle('open', !isOpen);
      });
    });

    // TOC active state tracking
    const tocLinks = wrapper.querySelectorAll('[data-toc-link]');
    if (tocLinks.length > 0) {
      const headings = Array.from(tocLinks)
        .map((link) => {
          const id = link.getAttribute('href')?.slice(1);
          return id ? document.getElementById(id) : null;
        })
        .filter(Boolean) as HTMLElement[];

      if (headings.length > 0) {
        let activeLink: Element | null = null;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                const link = wrapper.querySelector(`[data-toc-link][href="#${id}"]`);

                if (activeLink) activeLink.classList.remove('active');
                if (link) {
                  link.classList.add('active');
                  activeLink = link;
                }
              }
            });
          },
          { rootMargin: '-80px 0px -80% 0px', threshold: 0 }
        );

        headings.forEach((h) => observer.observe(h));
      }
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRightSidebar);
  } else {
    initRightSidebar();
  }

  document.addEventListener('astro:after-swap', () => {
    // Reset init flag for new page
    const wrapper = document.getElementById('right-sidebar-wrapper');
    wrapper?.removeAttribute('data-init');
    initRightSidebar();
  });

  document.addEventListener('swup:contentReplaced', () => {
    const wrapper = document.getElementById('right-sidebar-wrapper');
    wrapper?.removeAttribute('data-init');
    initRightSidebar();
  });
</script>
