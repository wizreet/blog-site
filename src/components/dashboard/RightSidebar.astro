---
/**
 * Right Sidebar Component
 *
 * @description Shows series and categories navigation with collapse toggle.
 *
 * Features:
 * - Series list with post counts
 * - Categories list with post counts
 * - Collapse toggle button
 *
 * @example
 * ```astro
 * <RightSidebar />
 * ```
 */

import { Icon } from 'astro-icon/components';
import { getCategoryList, getSeriesWithCounts } from '@utils/content-utils';
import { getUrl } from '@utils/url-utils';
import { i18n, I18nKey } from '@i18n/index';
import type { MarkdownHeading } from 'astro';

interface Props {
  /** Headings for table of contents (optional) */
  headings?: MarkdownHeading[];
}

const { headings = [] } = Astro.props;

// Fetch data
const categories = await getCategoryList();
const seriesWithCounts = await getSeriesWithCounts();

// Only show series that have posts
const seriesWithPosts = seriesWithCounts.filter((s) => s.postCount > 0);

// Filter to h2 and h3 only for TOC
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

<div class="sidebar-wrapper">
  {/* Collapse Toggle Header */}
  <button
    id="right-sidebar-toggle"
    class="sidebar-toggle-btn"
    aria-label="Collapse sidebar"
    title="Collapse sidebar"
  >
    <Icon name="material-symbols:chevron-right" class="toggle-icon" />
  </button>

  <div class="right-sidebar-content">
    {/* Table of Contents (if headings provided) */}
    {tocHeadings.length > 0 && (
      <section class="nav-section">
        <header class="section-header">
          <Icon name="material-symbols:list" class="section-icon" />
          <span class="section-title">{i18n(I18nKey.tableOfContents)}</span>
        </header>
        <nav class="section-body toc-nav">
          <ul class="toc-list" role="list">
            {tocHeadings.map((heading) => (
              <li class:list={['toc-item', `depth-${heading.depth}`]}>
                <a
                  href={`#${heading.slug}`}
                  class="toc-link"
                  data-toc-link
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </section>
    )}

    {/* Series Section */}
    {seriesWithPosts.length > 0 && (
      <section class="nav-section">
        <header class="section-header">
          <Icon name="material-symbols:library-books" class="section-icon" />
          <span class="section-title">{i18n(I18nKey.series)}</span>
          <span class="section-count">{seriesWithPosts.length}</span>
        </header>
        <div class="section-body">
          {seriesWithPosts.map((series) => (
            <a
              href={getUrl(`/series/${series.id}/`)}
              class="nav-link"
            >
              <Icon name="material-symbols:book-2-outline" class="nav-icon" />
              <span class="nav-name">{series.title}</span>
              <span class:list={['status-badge', series.status]}>{series.postCount}</span>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Categories Section */}
    <section class="nav-section">
      <header class="section-header">
        <Icon name="material-symbols:folder-open" class="section-icon" />
        <span class="section-title">{i18n(I18nKey.categories)}</span>
        <span class="section-count">{categories.length}</span>
      </header>
      <div class="section-body">
        {categories.map((category) => (
          <a
            href={getUrl(`/categories/${category.name.toLowerCase()}/`)}
            class="nav-link"
          >
            <Icon name="material-symbols:label-outline" class="nav-icon" />
            <span class="nav-name">{category.name}</span>
            <span class="count-badge">{category.count}</span>
          </a>
        ))}
      </div>
    </section>
  </div>
</div>

<style>
  .sidebar-wrapper {
    position: relative;
  }

  .sidebar-toggle-btn {
    position: absolute;
    top: 0.5rem;
    left: -0.5rem;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 50%;
    background: var(--card-bg);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .sidebar-toggle-btn:hover {
    color: var(--text-primary);
    background: var(--btn-hover-bg);
  }

  .toggle-icon {
    width: 1rem;
    height: 1rem;
  }

  .right-sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Section */
  .nav-section {
    background: var(--card-bg);
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: oklch(var(--primary) / 0.05);
    border-bottom: 1px solid var(--border-color);
  }

  .section-icon {
    width: 1rem;
    height: 1rem;
    color: oklch(var(--primary));
  }

  .section-title {
    flex: 1;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-primary);
  }

  .section-count {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 9999px;
    background: oklch(var(--primary) / 0.12);
    color: oklch(var(--primary));
  }

  .section-body {
    padding: 0.375rem;
  }

  /* Nav Links */
  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.625rem;
    border-radius: 0.375rem;
    text-decoration: none;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    transition: all 0.15s;
  }

  .nav-link:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .nav-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .nav-link:hover .nav-icon {
    opacity: 1;
    color: oklch(var(--primary));
  }

  .nav-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .count-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
  }

  .status-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
  }

  .status-badge.ongoing {
    background: oklch(0.7 0.15 145 / 0.15);
    color: oklch(0.5 0.15 145);
  }

  .status-badge.completed {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  /* TOC Nav */
  .toc-nav {
    max-height: 40vh;
    overflow-y: auto;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.625rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: all 0.15s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .toc-link:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .toc-link.active {
    background: oklch(var(--primary) / 0.1);
    color: oklch(var(--primary));
    font-weight: 500;
  }

  /* Indentation for heading levels */
  .toc-item.depth-3 .toc-link {
    padding-left: 1.25rem;
    font-size: 0.75rem;
  }
</style>

<script>
  /**
   * Right Sidebar Functionality
   */
  function initRightSidebar() {
    // TOC Active State Tracking
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    if (tocLinks.length > 0) {
      const headings = Array.from(tocLinks).map((link) => {
        const id = link.getAttribute('href')?.slice(1);
        return id ? document.getElementById(id) : null;
      }).filter(Boolean) as HTMLElement[];

      if (headings.length > 0) {
        const observerOptions = {
          rootMargin: '-80px 0px -80% 0px',
          threshold: 0,
        };

        let activeLink: Element | null = null;

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const id = entry.target.getAttribute('id');
              const link = document.querySelector(`[data-toc-link][href="#${id}"]`);

              if (activeLink) {
                activeLink.classList.remove('active');
              }

              if (link) {
                link.classList.add('active');
                activeLink = link;
              }
            }
          });
        }, observerOptions);

        headings.forEach((heading) => observer.observe(heading));
      }
    }

    // Right sidebar collapse toggle
    const rightToggle = document.getElementById('right-sidebar-toggle');
    const dashboardContainer = document.querySelector('.dashboard-container');
    
    if (rightToggle && dashboardContainer) {
      const savedState = localStorage.getItem('right-sidebar-collapsed');
      let isCollapsed = savedState === 'true';
      
      // Apply initial state
      if (isCollapsed) {
        dashboardContainer.classList.add('right-sidebar-collapsed');
      }
      
      // Clone to remove old listeners
      const newToggle = rightToggle.cloneNode(true) as HTMLElement;
      rightToggle.parentNode?.replaceChild(newToggle, rightToggle);
      
      newToggle.addEventListener('click', (e) => {
        e.preventDefault();
        isCollapsed = !isCollapsed;
        localStorage.setItem('right-sidebar-collapsed', isCollapsed.toString());
        
        const container = document.querySelector('.dashboard-container');
        if (isCollapsed) {
          container?.classList.add('right-sidebar-collapsed');
        } else {
          container?.classList.remove('right-sidebar-collapsed');
        }
      });
    }
  }

  // Initialize on page load and transitions
  document.addEventListener('DOMContentLoaded', initRightSidebar);
  document.addEventListener('astro:after-swap', initRightSidebar);
  document.addEventListener('swup:contentReplaced', initRightSidebar);
  
  // Fallback
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initRightSidebar();
  }
</script>
