---
/**
 * Left Sidebar Component
 *
 * @description Navigation dashboard showing all posts organized by series and categories.
 * No "View All" links - everything is shown directly.
 */

import { Icon } from 'astro-icon/components';
import { getCategoryList, getSeriesWithCounts, getSortedPosts } from '@utils/content-utils';
import { getUrl, getPostUrl } from '@utils/url-utils';
import { i18n, I18nKey } from '@i18n/index';

interface Props {
  activeCategory?: string;
  activeSeries?: string;
  activePost?: string;
}

const { activeCategory, activeSeries, activePost } = Astro.props;

// Fetch data
const categories = await getCategoryList();
const seriesWithCounts = await getSeriesWithCounts();
const allPosts = await getSortedPosts();

// Only show series that have posts
const seriesWithPosts = seriesWithCounts.filter((s) => s.postCount > 0);

// Group posts by category
const postsByCategory = new Map<string, typeof allPosts>();
categories.forEach((cat) => {
  const posts = allPosts.filter(
    (p) => p.data.category?.toLowerCase() === cat.name.toLowerCase()
  );
  postsByCategory.set(cat.name.toLowerCase(), posts);
});

// Group posts by series
const postsBySeries = new Map<string, typeof allPosts>();
seriesWithPosts.forEach((series) => {
  const posts = allPosts.filter((p) => p.data.series?.id === series.id);
  postsBySeries.set(series.id, posts);
});
---

<div class="sidebar-wrapper">
  {/* Collapse Toggle Header */}
  <button
    id="left-sidebar-toggle"
    class="sidebar-toggle-btn"
    aria-label="Collapse sidebar"
    title="Collapse sidebar"
  >
    <Icon name="material-symbols:chevron-left" class="toggle-icon" />
  </button>

  <nav class="sidebar-nav" aria-label={i18n(I18nKey.categories)}>
    <!-- Series Section -->
    {seriesWithPosts.length > 0 && (
      <section class="nav-section">
        <header class="section-header">
          <Icon name="material-symbols:library-books" class="section-icon" />
          <span class="section-title">{i18n(I18nKey.series)}</span>
          <span class="section-count">{seriesWithPosts.length}</span>
        </header>

      <div class="section-body">
        {seriesWithPosts.map((series) => {
          const seriesPosts = postsBySeries.get(series.id) || [];
          const isActive = activeSeries === series.id;
          return (
            <div class="nav-group" data-group="series">
              <button
                class:list={['group-header', { active: isActive }]}
                data-toggle
                aria-expanded={isActive ? 'true' : 'false'}
              >
                <Icon name="material-symbols:book-2-outline" class="group-icon" />
                <span class="group-name">{series.title}</span>
                <span class:list={['status-badge', series.status]}>{series.postCount}</span>
                <Icon name="material-symbols:chevron-right" class="chevron" />
              </button>
              <ul class="post-list" data-panel>
                {seriesPosts.map((post, idx) => (
                  <li>
                    <a
                      href={getPostUrl(post.id)}
                      class:list={['post-item', { active: activePost === post.id }]}
                    >
                      <span class="post-num">{idx + 1}</span>
                      <span class="post-name">{post.data.title}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          );
        })}
      </div>
    </section>
  )}

  <!-- Categories Section -->
  <section class="nav-section">
    <header class="section-header">
      <Icon name="material-symbols:folder-open" class="section-icon" />
      <span class="section-title">{i18n(I18nKey.categories)}</span>
      <span class="section-count">{categories.length}</span>
    </header>

    <div class="section-body">
      <!-- All Posts -->
      <a
        href={getUrl('/posts/')}
        class:list={['all-link', { active: !activeCategory && !activeSeries }]}
      >
        <Icon name="material-symbols:article-outline" class="group-icon" />
        <span class="group-name">{i18n(I18nKey.allPosts)}</span>
        <span class="count-badge">{allPosts.length}</span>
      </a>

      <!-- Categories -->
      {categories.map((category) => {
        const categoryPosts = postsByCategory.get(category.name.toLowerCase()) || [];
        const isActive = activeCategory?.toLowerCase() === category.name.toLowerCase();
        return (
          <div class="nav-group" data-group="category">
            <button
              class:list={['group-header', { active: isActive }]}
              data-toggle
              aria-expanded={isActive ? 'true' : 'false'}
            >
              <Icon name="material-symbols:label-outline" class="group-icon" />
              <span class="group-name">{category.name}</span>
              <span class="count-badge">{category.count}</span>
              <Icon name="material-symbols:chevron-right" class="chevron" />
            </button>
            <ul class="post-list" data-panel>
              {categoryPosts.map((post) => (
                <li>
                  <a
                    href={getPostUrl(post.id)}
                    class:list={['post-item', { active: activePost === post.id }]}
                  >
                    <span class="post-name">{post.data.title}</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        );
      })}
    </div>
  </section>
  </nav>
</div>

<style>
  .sidebar-wrapper {
    position: relative;
  }

  .sidebar-toggle-btn {
    position: absolute;
    top: 0.5rem;
    right: -0.5rem;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 50%;
    background: var(--card-bg);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .sidebar-toggle-btn:hover {
    color: var(--text-primary);
    background: var(--btn-hover-bg);
  }

  .toggle-icon {
    width: 1rem;
    height: 1rem;
  }

  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Section */
  .nav-section {
    background: var(--card-bg);
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: oklch(var(--primary) / 0.05);
    border-bottom: 1px solid var(--border-color);
  }

  .section-icon {
    width: 1rem;
    height: 1rem;
    color: oklch(var(--primary));
  }

  .section-title {
    flex: 1;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-primary);
  }

  .section-count {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 9999px;
    background: oklch(var(--primary) / 0.12);
    color: oklch(var(--primary));
  }

  .section-body {
    padding: 0.375rem;
  }

  /* All Posts Link */
  .all-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.625rem;
    border-radius: 0.375rem;
    text-decoration: none;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    transition: all 0.15s;
    margin-bottom: 0.25rem;
  }

  .all-link:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .all-link.active {
    background: oklch(var(--primary) / 0.1);
    color: oklch(var(--primary));
  }

  .all-link .group-icon {
    width: 1rem;
    height: 1rem;
    color: inherit;
    opacity: 0.7;
  }

  .all-link .group-name {
    flex: 1;
  }

  .all-link .count-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
  }

  .all-link.active .count-badge {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  /* Nav Group */
  .nav-group {
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .group-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.625rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    font-family: inherit;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
  }

  .group-header:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .group-header.active {
    background: oklch(var(--primary) / 0.1);
    color: oklch(var(--primary));
  }

  .group-header[aria-expanded='true'] {
    background: oklch(var(--primary) / 0.08);
    color: oklch(var(--primary));
  }

  .group-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    color: inherit;
    opacity: 0.7;
  }

  .group-header:hover .group-icon,
  .group-header.active .group-icon,
  .group-header[aria-expanded='true'] .group-icon {
    opacity: 1;
    color: oklch(var(--primary));
  }

  .group-name {
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .count-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
  }

  .group-header.active .count-badge,
  .group-header[aria-expanded='true'] .count-badge {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  .status-badge {
    font-size: 0.6875rem;
    padding: 0.0625rem 0.375rem;
    border-radius: 9999px;
    background: var(--btn-regular-bg);
    color: var(--text-tertiary);
  }

  .status-badge.completed {
    background: oklch(0.45 0.12 145 / 0.15);
    color: oklch(0.55 0.15 145);
  }

  .status-badge.ongoing {
    background: oklch(var(--primary) / 0.15);
    color: oklch(var(--primary));
  }

  .chevron {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--text-tertiary);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .group-header[aria-expanded='true'] .chevron {
    transform: rotate(90deg);
    color: oklch(var(--primary));
  }

  /* Post List */
  .post-list {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0.25rem 0 0.25rem 1.5rem;
    border-left: 2px solid var(--border-color);
    margin-left: 0.75rem;
  }

  .post-list[data-expanded='true'] {
    display: block;
  }

  .post-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.5rem;
    border-radius: 0.25rem;
    text-decoration: none;
    font-size: 0.75rem;
    color: var(--text-secondary);
    transition: all 0.15s;
    white-space: nowrap;
    overflow: hidden;
  }

  .post-item:hover {
    background: var(--btn-hover-bg);
    color: var(--text-primary);
  }

  .post-item.active {
    background: oklch(var(--primary) / 0.1);
    color: oklch(var(--primary));
  }

  .post-num {
    width: 1.125rem;
    height: 1.125rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    font-weight: 600;
    border-radius: 0.25rem;
    background: var(--border-color);
    color: var(--text-tertiary);
    flex-shrink: 0;
  }

  .post-item.active .post-num {
    background: oklch(var(--primary) / 0.2);
    color: oklch(var(--primary));
  }

  .post-name {
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>

<script>
  function initSidebar() {
    const toggles = document.querySelectorAll('[data-toggle]');

    toggles.forEach((btn) => {
      const newBtn = btn.cloneNode(true) as HTMLElement;
      btn.parentNode?.replaceChild(newBtn, btn);

      newBtn.addEventListener('click', () => {
        const group = newBtn.closest('.nav-group');
        const panel = group?.querySelector('[data-panel]');
        const groupType = group?.getAttribute('data-group');
        const isOpen = newBtn.getAttribute('aria-expanded') === 'true';

        // Close others in same group type
        if (groupType) {
          document.querySelectorAll(`.nav-group[data-group="${groupType}"]`).forEach((g) => {
            if (g !== group) {
              g.querySelector('[data-toggle]')?.setAttribute('aria-expanded', 'false');
              g.querySelector('[data-panel]')?.removeAttribute('data-expanded');
            }
          });
        }

        // Toggle current
        newBtn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        if (isOpen) {
          panel?.removeAttribute('data-expanded');
        } else {
          panel?.setAttribute('data-expanded', 'true');
        }
      });
    });

    // Auto-expand active
    document.querySelectorAll('.group-header.active').forEach((btn) => {
      const group = btn.closest('.nav-group');
      const panel = group?.querySelector('[data-panel]');
      btn.setAttribute('aria-expanded', 'true');
      panel?.setAttribute('data-expanded', 'true');
    });

    // Left sidebar collapse toggle
    const leftToggle = document.getElementById('left-sidebar-toggle');
    const dashboardContainer = document.querySelector('.dashboard-container');
    
    if (leftToggle && dashboardContainer) {
      const savedState = localStorage.getItem('left-sidebar-collapsed');
      let isCollapsed = savedState === 'true';
      
      // Apply initial state
      if (isCollapsed) {
        dashboardContainer.classList.add('left-sidebar-collapsed');
      }
      
      // Clone to remove old listeners
      const newToggle = leftToggle.cloneNode(true) as HTMLElement;
      leftToggle.parentNode?.replaceChild(newToggle, leftToggle);
      
      newToggle.addEventListener('click', (e) => {
        e.preventDefault();
        isCollapsed = !isCollapsed;
        localStorage.setItem('left-sidebar-collapsed', isCollapsed.toString());
        
        const container = document.querySelector('.dashboard-container');
        if (isCollapsed) {
          container?.classList.add('left-sidebar-collapsed');
        } else {
          container?.classList.remove('left-sidebar-collapsed');
        }
      });
    }
  }

  initSidebar();
  document.addEventListener('astro:after-swap', initSidebar);
  document.addEventListener('swup:contentReplaced', initSidebar);
</script>
