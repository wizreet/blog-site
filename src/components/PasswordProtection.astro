---
/**
 * Password Protection Component
 *
 * @description Displays a password input for encrypted content.
 * Based on Mizuki's PasswordProtection component.
 */

interface Props {
  encryptedContent: string;
}

const { encryptedContent } = Astro.props;
---

<div class="password-protection card-base p-6" data-encrypted={encryptedContent}>
  <div class="locked-state text-center">
    <div class="mb-4 flex justify-center">
      <div class="flex h-16 w-16 items-center justify-center rounded-full bg-[oklch(var(--primary)/0.1)]">
        <svg class="h-8 w-8 text-[oklch(var(--primary))]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
    </div>
    <h3 class="mb-2 text-lg font-semibold text-[var(--text-primary)]">Encrypted Content</h3>
    <p class="mb-4 text-sm text-[var(--text-secondary)]">Enter the password to unlock this content</p>
    <div class="flex flex-col gap-3 sm:flex-row sm:justify-center">
      <input
        type="password"
        class="password-input rounded-lg border border-[var(--border-color)] bg-[var(--card-bg)] px-4 py-2 text-[var(--text-primary)] focus:border-[oklch(var(--primary))] focus:outline-none focus:ring-1 focus:ring-[oklch(var(--primary))]"
        placeholder="Password"
      />
      <button
        type="button"
        class="unlock-btn rounded-lg bg-[oklch(var(--primary))] px-6 py-2 font-medium text-white transition-colors hover:bg-[oklch(var(--primary)/0.9)]"
      >
        Unlock
      </button>
    </div>
    <p class="error-message mt-2 hidden text-sm text-red-500">Incorrect password</p>
  </div>

  <div class="unlocked-content hidden">
    <!-- Decrypted content will be inserted here -->
  </div>
</div>

<script>
  import CryptoJS from 'crypto-js';

  function initPasswordProtection() {
    document.querySelectorAll('.password-protection').forEach((container) => {
      const encryptedContent = container.getAttribute('data-encrypted');
      const input = container.querySelector('.password-input') as HTMLInputElement;
      const button = container.querySelector('.unlock-btn');
      const errorMsg = container.querySelector('.error-message');
      const lockedState = container.querySelector('.locked-state');
      const unlockedContent = container.querySelector('.unlocked-content');

      if (!encryptedContent || !input || !button || !errorMsg || !lockedState || !unlockedContent) return;

      const tryUnlock = () => {
        const password = input.value;
        if (!password) return;

        try {
          const decrypted = CryptoJS.AES.decrypt(encryptedContent, password).toString(CryptoJS.enc.Utf8);

          if (decrypted.startsWith('MIZUKI-VERIFY:')) {
            const content = decrypted.replace('MIZUKI-VERIFY:', '');
            unlockedContent.innerHTML = content;
            lockedState.classList.add('hidden');
            unlockedContent.classList.remove('hidden');
            errorMsg.classList.add('hidden');
          } else {
            throw new Error('Invalid password');
          }
        } catch (e) {
          errorMsg.classList.remove('hidden');
          input.classList.add('border-red-500');
          setTimeout(() => {
            input.classList.remove('border-red-500');
          }, 2000);
        }
      };

      button.addEventListener('click', tryUnlock);
      input.addEventListener('keypress', (e) => {
        if ((e as KeyboardEvent).key === 'Enter') tryUnlock();
      });
    });
  }

  // Initialize on page load and Swup page transitions
  document.addEventListener('DOMContentLoaded', initPasswordProtection);
  document.addEventListener('swup:contentReplaced', initPasswordProtection);
</script>
