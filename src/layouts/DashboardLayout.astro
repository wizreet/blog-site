---
/**
 * Dashboard Layout
 *
 * @description Clean three-column layout with proper sidebar toggle management.
 * No left gap when hideLeftSidebar is true, proper state persistence.
 */

import Layout from './Layout.astro';
import Navbar from '@components/Navbar.astro';
import Footer from '@components/Footer.astro';
import BackToTop from '@components/BackToTop.astro';
import LeftSidebar from '@components/dashboard/LeftSidebar.astro';
import RightSidebar from '@components/dashboard/RightSidebar.astro';
import TOC from '@components/widget/TOC.astro';
import type { MarkdownHeading } from 'astro';

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  url?: string;
  publishDate?: Date;
  modifiedDate?: Date;
  isArticle?: boolean;
  robots?: string;
  hideLeftSidebar?: boolean;
  hideRightSidebar?: boolean;
  showTocOnLeft?: boolean;
  headings?: MarkdownHeading[];
  contentClass?: string;
  activeCategory?: string;
  activeSeries?: string;
  activePost?: string;
}

const {
  title,
  description,
  ogImage,
  url,
  publishDate,
  modifiedDate,
  isArticle = false,
  robots,
  hideLeftSidebar = false,
  hideRightSidebar = false,
  showTocOnLeft = false,
  headings = [],
  contentClass = '',
  activeCategory,
  activeSeries,
  activePost,
} = Astro.props;

const hasLeftSlot = Astro.slots.has('left-sidebar');
const hasRightSlot = Astro.slots.has('right-sidebar');
---

<Layout
  title={title}
  description={description}
  ogImage={ogImage}
  url={url}
  publishDate={publishDate}
  modifiedDate={modifiedDate}
  isArticle={isArticle}
  robots={robots}
>
  <Navbar />

  <div 
    class="dashboard-container" 
    data-hide-left={hideLeftSidebar ? 'true' : 'false'}
    data-hide-right={hideRightSidebar ? 'true' : 'false'}
  >
    <div class="dashboard-grid">
      {/* Left Sidebar */}
      {!hideLeftSidebar && (
        <aside class="left-sidebar" data-sidebar="left">
          <div class="sidebar-inner">
            {hasLeftSlot ? (
              <slot name="left-sidebar" />
            ) : showTocOnLeft ? (
              <TOC headings={headings} />
            ) : (
              <LeftSidebar
                activeCategory={activeCategory ?? ''}
                activeSeries={activeSeries ?? ''}
                activePost={activePost ?? ''}
              />
            )}
          </div>
        </aside>
      )}

      {/* Main Content */}
      <main
        id="main-content"
        class:list={['main-content', contentClass]}
      >
        <slot />
      </main>

      {/* Right Sidebar */}
      {!hideRightSidebar && (
        <aside class="right-sidebar" data-sidebar="right">
          <div class="sidebar-inner">
            {hasRightSlot ? (
              <slot name="right-sidebar" />
            ) : (
              <RightSidebar headings={showTocOnLeft ? [] : headings} />
            )}
          </div>
        </aside>
      )}
    </div>
  </div>

  <Footer />
  <BackToTop />
</Layout>

<style>
  .dashboard-container {
    width: 100%;
    min-height: calc(100vh - var(--navbar-height) - 4rem);
    padding-top: calc(var(--navbar-height) + 1rem);
    padding-bottom: 1.5rem;
  }

  .dashboard-grid {
    display: grid;
    gap: 1.25rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
    grid-template-columns: 1fr;
  }

  .left-sidebar,
  .right-sidebar {
    display: none;
  }

  .sidebar-inner {
    position: sticky;
    top: calc(var(--navbar-height) + 1rem);
    max-height: calc(100vh - var(--navbar-height) - 2rem);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) transparent;
  }

  .sidebar-inner::-webkit-scrollbar {
    width: 4px;
  }

  .sidebar-inner::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 2px;
  }

  /* Tablet: Main + Right */
  @media (min-width: 768px) {
    .dashboard-container {
      padding: calc(var(--navbar-height) + 1.25rem) 1.25rem 1.5rem;
    }

    .dashboard-grid {
      grid-template-columns: 1fr 260px;
    }

    .right-sidebar {
      display: block;
    }

    /* When right is hidden via prop */
    .dashboard-container[data-hide-right='true'] .dashboard-grid {
      grid-template-columns: 1fr;
    }

    /* When right is collapsed via toggle */
    .dashboard-container[data-right-collapsed='true'] .right-sidebar {
      display: none;
    }

    .dashboard-container[data-right-collapsed='true'] .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Desktop: Left + Main + Right */
  @media (min-width: 1024px) {
    .dashboard-container {
      padding: calc(var(--navbar-height) + 1.5rem) 1.5rem 1.5rem;
    }

    .dashboard-grid {
      grid-template-columns: 240px 1fr 260px;
    }

    .left-sidebar {
      display: block;
    }

    /* When left is hidden via prop - no gap on left */
    .dashboard-container[data-hide-left='true'] .dashboard-grid {
      grid-template-columns: 1fr 260px;
    }

    /* When right is hidden via prop */
    .dashboard-container[data-hide-right='true'] .dashboard-grid {
      grid-template-columns: 240px 1fr;
    }

    /* When both hidden via props */
    .dashboard-container[data-hide-left='true'][data-hide-right='true'] .dashboard-grid {
      grid-template-columns: 1fr;
      max-width: 900px;
    }

    /* Collapsed states via toggle */
    .dashboard-container[data-left-collapsed='true'] .left-sidebar {
      display: none;
    }

    .dashboard-container[data-left-collapsed='true'] .dashboard-grid {
      grid-template-columns: 1fr 260px;
    }

    .dashboard-container[data-right-collapsed='true'] .right-sidebar {
      display: none;
    }

    .dashboard-container[data-right-collapsed='true'] .dashboard-grid {
      grid-template-columns: 240px 1fr;
    }

    /* Combined prop + collapsed states */
    .dashboard-container[data-hide-left='true'][data-right-collapsed='true'] .dashboard-grid,
    .dashboard-container[data-left-collapsed='true'][data-hide-right='true'] .dashboard-grid,
    .dashboard-container[data-left-collapsed='true'][data-right-collapsed='true'] .dashboard-grid {
      grid-template-columns: 1fr;
      max-width: 900px;
    }
  }

  /* Large Desktop */
  @media (min-width: 1280px) {
    .dashboard-grid {
      max-width: 1440px;
      grid-template-columns: 260px 1fr 280px;
    }

    .dashboard-container[data-hide-left='true'] .dashboard-grid {
      grid-template-columns: 1fr 280px;
    }

    .dashboard-container[data-hide-right='true'] .dashboard-grid {
      grid-template-columns: 260px 1fr;
    }

    .dashboard-container[data-left-collapsed='true'] .dashboard-grid {
      grid-template-columns: 1fr 280px;
    }

    .dashboard-container[data-right-collapsed='true'] .dashboard-grid {
      grid-template-columns: 260px 1fr;
    }
  }
</style>

<script>
  /**
   * Sidebar State Manager
   * Clean, professional implementation with no race conditions
   */
  const SidebarManager = {
    STORAGE_KEY: 'sidebar-state',
    
    getState(): { leftCollapsed: boolean; rightCollapsed: boolean } {
      try {
        const stored = localStorage.getItem(this.STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.warn('Failed to read sidebar state:', e);
      }
      return { leftCollapsed: false, rightCollapsed: false };
    },

    setState(state: { leftCollapsed?: boolean; rightCollapsed?: boolean }) {
      const current = this.getState();
      const newState = { ...current, ...state };
      try {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(newState));
      } catch (e) {
        console.warn('Failed to save sidebar state:', e);
      }
      return newState;
    },

    applyToDOM() {
      const container = document.querySelector('.dashboard-container');
      if (!container) return;

      const state = this.getState();
      
      if (state.leftCollapsed) {
        container.setAttribute('data-left-collapsed', 'true');
      } else {
        container.removeAttribute('data-left-collapsed');
      }

      if (state.rightCollapsed) {
        container.setAttribute('data-right-collapsed', 'true');
      } else {
        container.removeAttribute('data-right-collapsed');
      }
    },

    toggleLeft() {
      const state = this.getState();
      this.setState({ leftCollapsed: !state.leftCollapsed });
      this.applyToDOM();
    },

    toggleRight() {
      const state = this.getState();
      this.setState({ rightCollapsed: !state.rightCollapsed });
      this.applyToDOM();
    }
  };

  // Make available globally for sidebar toggle buttons
  (window as any).SidebarManager = SidebarManager;

  // Apply state on load
  function initSidebarState() {
    SidebarManager.applyToDOM();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarState);
  } else {
    initSidebarState();
  }

  document.addEventListener('astro:after-swap', initSidebarState);
  document.addEventListener('swup:contentReplaced', initSidebarState);
</script>
